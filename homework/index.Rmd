---
title: "Homework 5"
output: 
  html_document:
    keep_md: TRUE
---

####Goals:

1. Reorder a factor in a principled way based on the data and demonstrate the effect in arranged data and in figures.
2. Remake at least one previously made figure, in light of recent coverage of visualization design principles.
3. Write a figure to file explicitly and include it your R Markdown report via `![Alt text](/path/to/img.png)`.
4. Clean up your repo, to celebrate the completion of STAT 545 and/or to prepare for the glorious future of STAT 547.
  
  **Note to student evaluators:** Yes, I have gotten the OK from Jenny on working with this dataset.  


Before we dive in, let's load our dependent packages and bring in our data.  
```{r}
# install.packages("FactoMineR", dependencies = TRUE)
library(FactoMineR)
# devtools::install_github("vqv/ggbiplot")
suppressPackageStartupMessages(library(ggbiplot))
library(ggplot2)
library(knitr)
suppressPackageStartupMessages(library(dplyr))
library(tidyr)
library(broom)
library(maps)
library(RColorBrewer)
# Pull the CSV from this url
PSE <- url('http://s3.amazonaws.com/ed-college-choice-public/Most+Recent+Cohorts+(Treasury+Elements).csv')
pse <- read.csv(PSE, header=TRUE, na.strings = c("NULL", "PrivacySuppressed")) %>% 
  tbl_df()
SC <- url('http://s3.amazonaws.com/ed-college-choice-public/Most+Recent+Cohorts+(Scorecard+Elements).csv')
sc <- read.csv(SC, header=TRUE, na.strings = c("NULL", "PrivacySuppressed")) %>% 
  tbl_df()
union <- inner_join(pse, sc)
subunion <- union %>% 
  select(INSTNM, CONTROL, age_entry, married, md_faminc, median_hh_inc, pct_white, md_earn_wne_p10, poverty_rate, unemp_rate, pct_born_us)
head(subunion) %>% 
  knitr::kable("markdown")
```

#### 1. Reorder a factor in a principled way based on the data and demonstrate the effect in arranged data and in figures.  

Let's take a snippet of data to work with--the entire dataset is just too wide to work with 
```{r}
subset <- subunion %>%
  select(INSTNM, CONTROL, median_hh_inc, poverty_rate, age_entry, married)
subset %>% 
  head() %>% 
  kable("markdown")
```

Okay, let's perform a basic `arrange()`.
```{r}
subset %>% 
  arrange(CONTROL) %>% 
  head() %>% 
  kable("markdown")
```

Okay, so that works.  But I think it's important to note that we can use the non-standard evaluation `arrange_()` on a character string for the column name.
```{r}
subset %>% 
  arrange_("CONTROL") %>% 
  head() %>% 
  kable("markdown")
```

Let's move on to `reorder()`, how does that work? According to the documentation, it "reorders its levels".  
```{r}
glimpse(subset)
```

I'll have to use INSTNM instead of CONTROL because it's the only factor in my data set! 
```{r, error = TRUE}
reorder(x = subset$INSTNM) %>% 
  head() %>% 
  kable("markdown")
```

This doesn't seem to work, but even if it did it wouldn't be very useful, since `nrow(subset)` is nearly equal to `length(unique(levels(subset$INSTNM)))`.  
```{r}
nrow(subset)
length(unique(levels(subset$INSTNM)))
```

It'd be great if we could go by state name! Let's pull the state abbreviations for this exercise.  Unfortunately this is a pretty big file
```{r}
recent <- url('http://s3.amazonaws.com/ed-college-choice-public/Most+Recent+Cohorts+(All+Data+Elements).csv')
recent <- read.csv(SC, header=TRUE, na.strings = c("NULL", "PrivacySuppressed")) %>% 
  tbl_df()
```

Now let's make this into a MUCH smaller subset so that we can join just the state abbreviations (STABBR), and perhaps the Accrediting Agency for the college as well.
```{r}
recent_subset <- recent %>% 
  select(UNITID, INSTNM, STABBR, AccredAgency)
full_picture <- inner_join(subset, recent_subset)
full_picture %>% 
  head() %>% 
  kable("markdown")
glimpse(full_picture)
```

Now we can go ahead and order our data table based on some more meaningful things than the alphabet.  Let's try `reorder()` again with the state abbreviations.  First let's make our initial unordered plots.  
First with the maximum poverty rate in each state. 
```{r}
str(full_picture)
full_picture <- na.omit(full_picture)
state_max <- full_picture %>%
  group_by(STABBR) %>%
  summarize(max_pov = max(poverty_rate))
state_max
ggplot(state_max, aes(x = STABBR, y = max_pov, group = 1)) +
  geom_path() + geom_point()
```

Now with the mean poverty rate in each state
```{r}
state_med <- full_picture %>%
  group_by(STABBR) %>%
  summarize(med_pov = median(poverty_rate))
ggplot(state_med, aes(x = STABBR, y = med_pov, group = 1)) +
  geom_path() + geom_point()
```

Okay, now let's reorder the factors to something more meaningful! Let's go by poverty rate since that's what we're measuring.  That initial plot was jumping all over the place and was only ordered alphabetically!
```{r}
Rpict <- full_picture %>% 
  mutate(STABBR = reorder(STABBR, poverty_rate, max))
data.frame(before = levels(full_picture$STABBR), after = levels(Rpict$STABBR))
Rstate <- state_max %>%
  mutate(STABBR = reorder(STABBR, max_pov, FUN = max))
```


And now the figure again
```{r}
ggplot(Rstate, aes(x = STABBR, y = max_pov, group = 1)) +
  geom_point() + geom_line()
```

And our next figure?
```{r}
Mstate <- state_med %>%
  mutate(STABBR = reorder(STABBR, med_pov, FUN = median))
ggplot(Mstate, aes(x = STABBR, y = med_pov, group = 1)) +
  geom_point() + geom_line()
```
#### 2. Remake at least one previously made figure, in light of recent coverage of visualization design principles.

I'd like to use a continuous variable with a saturation or luminance gradient to illustrate a spectrum.

I would have liked to use states, but that'll take too long right now, I'll have to come back to this another time.  
```{r, error = TRUE}
us_state_map = map_data('state')
class(us_state_map)
ggplot(us_state_map, aes(x = long, y = lat, group = group)) +
    # geom_polygon(aes(fill = cut_number(rate, 5))) +
     geom_path(colour = 'gray', linestyle = 2)

# ggplot(Rpict, aes(map_id = STABBR)) + geom_map(aes(fill = poverty_rate), map = us_state_map) + expand_limits(x = us_state_map$long, y = us_state_map$lat)
```

How about something more simple?  Perhaps just a gradient based system using a predefined color palette.  
```{r}
state_married <- full_picture %>%
  group_by(STABBR) %>%
  summarize(med_married = median(married))
brewer <- brewer.pal(n = 9, "Greens") %>% 
  colorRampPalette()
colorpal <- brewer(length(state_married$med_married))
```

And on to the plot...
```{r}
state_married %>%
  mutate(STABBR = reorder(STABBR, med_married, FUN = median)) %>% 
ggplot(aes(x = STABBR, y = med_married)) +
  geom_bar(stat = "identity", aes(fill = colorpal))
```

#### 3. Write a figure to file explicitly and include it your R Markdown report via `![Alt text](/path/to/img.png)`.  
![PCA Plot](PCAplot_school-type.png)

Does the exclamation point need to be included?  
[PCA Plot](PCAplot_school-type.png)

Looks like the exclamation point allows the embed rather than a link.  

#### 4. Clean up your repo to prepare for the glorious future of STAT 547.  
Already done!

#### 5. Bonus: PCA Plots!
Let's try a PCA plot of these data
```{r}
subsetA <- subunion %>% 
   select(INSTNM, CONTROL, age_entry, married, md_faminc, median_hh_inc, pct_white, md_earn_wne_p10, poverty_rate, unemp_rate, pct_born_us)
subsetA <- inner_join(subsetA, recent_subset) %>% 
  na.omit()
glimpse(subsetA)
state <- subsetA$STABBR
agency <- subsetA$AccredAgency
CONTROL <- subsetA$CONTROL
class(CONTROL)
length(CONTROL)
length(state)
subsetB <- subsetA %>% 
  select(age_entry, married, md_faminc, median_hh_inc, pct_white, md_earn_wne_p10, poverty_rate, unemp_rate, pct_born_us)
sPCA <- prcomp(subsetB, scale. = TRUE)
summary(sPCA)
```

Now to the plot!
```{r}
g <- ggbiplot(sPCA, obs.scale = 1, var.scale = 1, 
              groups = state, 
              circle = TRUE)
g + scale_color_discrete(name = '') +
  theme(legend.direction = 'vertical', 
               legend.position = 'right') +
  ggtitle("PCA Plot of School States")
ggsave("PCA_states.png", g)
```

Wow, that's super colorful.  How about with just the regions?
```{r}
g <- ggbiplot(sPCA, obs.scale = 1, var.scale = 1, 
              groups = agency, 
              circle = TRUE)
g + scale_color_discrete(name = '') +
  theme(legend.direction = 'horizontal', 
               legend.position = 'top') + 
  ggtitle("PCA Plot of School Accrediting Agencies")
ggsave("PCAplot_region.png", g)
```

How about even fewer categorical variables? I want to use the type of school, CONTROL.
```{r, error = TRUE}
g <- ggbiplot(sPCA, obs.scale = 1, var.scale = 1, 
              groups = CONTROL, 
              circle = TRUE)
g + scale_color_discrete(name = '') +
  theme(legend.direction = 'horizontal', 
               legend.position = 'top')
```

Hmm, unfortunately this isn't working.  If we look up the documentation for `ggbiplot()`, we can see that `groups` must be a factor.  This could actually be helpful for us anyways to have our `CONTROL` group more descriptive!  For now let's just test this outside of the data.frame since that's how we'll be 
```{r}
controlFactor = factor(subsetA$CONTROL,labels=c("Public","Private nonprofit","Private-for-profit"))
class(controlFactor)
head(controlFactor)
```

Okay, let's try that again!
```{r}
g <- ggbiplot(sPCA, obs.scale = 1, var.scale = 1, 
              groups = controlFactor, 
              circle = TRUE)
g + scale_color_discrete(name = '') +
  theme(legend.direction = 'vertical', 
               legend.position = 'right') +
  ggtitle("PCA Plot of Public, Private nonprofit \n and Private for-profit Schools")
ggsave("PCAplot_school-type.png", g)
```

Cool! So what can we determine from this? Here are just some thoughts, some of these things we've previously inferred, and some are obvious!  
1. About 64% of the variation among our variables can be attributed to the two first principle components.  
2. Percent born & percent white are correlated, and are perhaps negatively correlated to public and private for-profit schools.  
3. Median household income, median family income, and median earnings 10 years later are all correlated, and are positively correlated to private non-profit schools.    
4. Percent married and average age of entry are correlated, and are perhaps negatively correlated with private nonprofit schools.  
5. Poverty rate and unemployment rate in the school area are correlated, and perhaps are slightly correlated to public & private for-profit schools.    

This is a great demonstration of why Principal Component Analysis is so helpful!  There's an entire plethora of information here that took me tons of other homework assignments and plots to figure out that I just found in one figure.  